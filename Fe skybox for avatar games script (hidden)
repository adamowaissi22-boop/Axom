local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "ScreenGui"
ScreenGui.ResetOnSpawn = false
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Size = UDim2.new(0, 300, 0, 400)
MainFrame.Position = UDim2.new(0.5, -150, 0.5, -200)
MainFrame.BackgroundColor3 = Color3.fromRGB(25, 40, 60)
MainFrame.BorderSizePixel = 2
MainFrame.BorderColor3 = Color3.fromRGB(0, 150, 255)
MainFrame.Active = true
MainFrame.Draggable = true

local TitleBar = Instance.new("Frame")
TitleBar.Name = "TitleBar"
TitleBar.Size = UDim2.new(1, 0, 0, 30)
TitleBar.BackgroundColor3 = Color3.fromRGB(15, 30, 50)
TitleBar.BorderSizePixel = 0

local TitleText = Instance.new("TextLabel")
TitleText.Name = "TitleText"
TitleText.Size = UDim2.new(1, -30, 1, 0)
TitleText.Position = UDim2.new(0, 10, 0, 0)
TitleText.BackgroundTransparency = 1
TitleText.Text = "Fe Skybox"
TitleText.TextColor3 = Color3.fromRGB(255, 255, 255)
TitleText.Font = Enum.Font.SourceSansBold
TitleText.TextSize = 16

local CloseButton = Instance.new("TextButton")
CloseButton.Name = "CloseButton"
CloseButton.Size = UDim2.new(0, 20, 0, 20)
CloseButton.Position = UDim2.new(1, -25, 0, 5)
CloseButton.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
CloseButton.Text = "X"
CloseButton.TextColor3 = Color3.fromRGB(255, 255, 255)
CloseButton.Font = Enum.Font.SourceSansBold
CloseButton.TextSize = 14

local ToggleButton = Instance.new("TextButton")
ToggleButton.Name = "ToggleButton"
ToggleButton.Size = UDim2.new(0, 200, 0, 40)
ToggleButton.Position = UDim2.new(0.5, -100, 0, 60)
ToggleButton.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
ToggleButton.Text = "Fe Skybox: OFF"
ToggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
ToggleButton.Font = Enum.Font.SourceSansBold
ToggleButton.TextSize = 18

local WarningText = Instance.new("TextLabel")
WarningText.Name = "WarningText"
WarningText.Size = UDim2.new(0, 280, 0, 150)
WarningText.Position = UDim2.new(0, 10, 0, 120)
WarningText.BackgroundTransparency = 1
WarningText.Text = "Warning : the game need to have an avatar shop like popmall avatar shop to wear it free (Try one).\n\nyou can try games like :\nChatbox [ðŸ’¬]\nAvatar Catalog\nCatalog Avatar Editor\nBrookhaven\nand other games."
WarningText.TextColor3 = Color3.fromRGB(255, 255, 255)
WarningText.Font = Enum.Font.SourceSans
WarningText.TextSize = 14
WarningText.TextWrapped = true
WarningText.TextYAlignment = Enum.TextYAlignment.Top

local CreditText = Instance.new("TextLabel")
CreditText.Name = "CreditText"
CreditText.Size = UDim2.new(1, 0, 0, 20)
CreditText.Position = UDim2.new(0, 0, 1, -25)
CreditText.BackgroundTransparency = 1
CreditText.Text = "made by axom"
CreditText.TextColor3 = Color3.fromRGB(200, 200, 200)
CreditText.Font = Enum.Font.SourceSans
CreditText.TextSize = 12

TitleBar.Parent = MainFrame
TitleText.Parent = TitleBar
CloseButton.Parent = TitleBar
ToggleButton.Parent = MainFrame
WarningText.Parent = MainFrame
CreditText.Parent = MainFrame
MainFrame.Parent = ScreenGui
ScreenGui.Parent = game.Players.LocalPlayer:WaitForChild("PlayerGui")

local currentAnimation = nil
local isEnabled = false

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")

player.CharacterAdded:Connect(function(newCharacter)
    character = newCharacter
    humanoid = character:WaitForChild("Humanoid")
end)

local Settings = {}
Settings["Stop On Move"] = false
Settings["Fade In"] = 0.1
Settings["Fade Out"] = 0.1
Settings["Weight"] = 1
Settings["Speed"] = 1
Settings["Allow Invisible"] = true
Settings["Time Position"] = 0

local CurrentTrack
local lastPosition = character.PrimaryPart and character.PrimaryPart.Position or Vector3.new()

local function extractIdFromInput(input)
    local num = tonumber(input)
    if num then
        return num
    end
    local assetIdMatch = string.match(input, "rbxassetid://(%d+)")
    if assetIdMatch then
        return tonumber(assetIdMatch)
    end
    local catalogMatch = string.match(input, "roblox%.com/catalog/(%d+)")
    if catalogMatch then
        return tonumber(catalogMatch)
    end
    local libraryMatch = string.match(input, "roblox%.com/library/(%d+)")
    if libraryMatch then
        return tonumber(libraryMatch)
    end
    local assetMatch = string.match(input, "roblox%.com/asset/%?id=(%d+)")
    if assetMatch then
        return tonumber(assetMatch)
    end
    return tonumber(input)
end

local function LoadTrack(id)
    if CurrentTrack then 
        CurrentTrack:Stop(0) 
    end

    local animId
    local ok, result = pcall(function()
        return game:GetObjects("rbxassetid://" .. tostring(id))
    end)

    if ok and result and #result > 0 then
        local anim = result[1]
        if anim:IsA("Animation") then
            animId = anim.AnimationId
        else
            animId = "rbxassetid://" .. tostring(id)
        end
    else
        animId = "rbxassetid://" .. tostring(id)
    end

    local newAnim = Instance.new("Animation")
    newAnim.AnimationId = animId
    local newTrack = humanoid:LoadAnimation(newAnim)
    newTrack.Priority = Enum.AnimationPriority.Action4

    local weight = Settings["Weight"]
    if weight == 0 then
        weight = 0.001
    end

    newTrack:Play(Settings["Fade In"], weight, Settings["Speed"])
    
    CurrentTrack = newTrack
    if CurrentTrack.Length > 0 then
        CurrentTrack.TimePosition = math.clamp(Settings["Time Position"], 0, 1) * CurrentTrack.Length
    end

    return newTrack
end

local function StopTrack()
    if CurrentTrack then
        CurrentTrack:Stop(Settings["Fade Out"])
        CurrentTrack = nil
    end
end

local originalCollisionStates = {}
local lastFixClipState = Settings["Allow Invisible"]

local function saveCollisionStates()
    for _, part in ipairs(character:GetDescendants()) do
        if part:IsA("BasePart") and part ~= character.PrimaryPart then
            originalCollisionStates[part] = part.CanCollide
        end
    end
end

local function disableCollisionsExceptRootPart()
    if not Settings["Allow Invisible"] then
        return
    end
    
    for _, part in ipairs(character:GetDescendants()) do
        if part:IsA("BasePart") and part ~= character.PrimaryPart then
            part.CanCollide = false
        end
    end
end

local function restoreCollisionStates()
    for part, canCollide in pairs(originalCollisionStates) do
        if part and part.Parent then
            part.CanCollide = canCollide
        end
    end
    originalCollisionStates = {}
end

saveCollisionStates()

local connection
connection = RunService.Stepped:Connect(function()
    if character and character.Parent then
        local currentFixClip = Settings["Allow Invisible"]
        
        if lastFixClipState ~= currentFixClip then
            if currentFixClip then
                saveCollisionStates()
                disableCollisionsExceptRootPart()
            else
                restoreCollisionStates()
            end
            lastFixClipState = currentFixClip
        elseif currentFixClip then
            disableCollisionsExceptRootPart()
        end
    else
        restoreCollisionStates()
        connection:Disconnect()
    end
end)

player.CharacterAdded:Connect(function(newCharacter)
    restoreCollisionStates()
    character = newCharacter
    humanoid = character:WaitForChild("Humanoid")
    
    saveCollisionStates()
    lastFixClipState = Settings["Allow Invisible"]
    
    if connection then
        connection:Disconnect()
    end
    
    connection = RunService.Stepped:Connect(function()
        if character and character.Parent then
            local currentFixClip = Settings["Allow Invisible"]
            
            if lastFixClipState ~= currentFixClip then
                if currentFixClip then
                    saveCollisionStates()
                    disableCollisionsExceptRootPart()
                else
                    restoreCollisionStates()
                end
                lastFixClipState = currentFixClip
            elseif currentFixClip then
                disableCollisionsExceptRootPart()
            end
        else
            restoreCollisionStates()
            connection:Disconnect()
        end
    end)
end)

RunService.RenderStepped:Connect(function()
    if character.PrimaryPart then
        if Settings["Stop On Move"] and CurrentTrack and CurrentTrack.IsPlaying then
            local movementDistance = (character.PrimaryPart.Position - lastPosition).Magnitude
            local isJumping = humanoid:GetState() == Enum.HumanoidStateType.Jumping
            
            if movementDistance > 0.1 or isJumping then
                CurrentTrack:Stop(Settings["Fade Out"])
                CurrentTrack = nil
            end
        end
        lastPosition = character.PrimaryPart.Position
    end
end)

CloseButton.MouseButton1Click:Connect(function()
    ScreenGui:Destroy()
end)

ToggleButton.MouseButton1Click:Connect(function()
    isEnabled = not isEnabled
    
    if isEnabled then
        ToggleButton.Text = "Fe Skybox: ON"
        ToggleButton.BackgroundColor3 = Color3.fromRGB(0, 150, 0)
        
        if game.PlaceId == 7822102405 then
            local args = {
                "add",
                100839513065432
            }
            game:GetService("ReplicatedStorage"):WaitForChild("Events"):WaitForChild("updateCharacter"):InvokeServer(unpack(args))
            
            wait(0.5)
            local animationID = extractIdFromInput("93224413172183")
            if animationID then
                CurrentTrack = LoadTrack(animationID)
            end
        elseif game.PlaceId == 4924922222 or game:GetService("MarketplaceService"):GetProductInfo(game.PlaceId).Name:find("Brookhaven") then
            game:GetService("ReplicatedStorage").Remotes.ChangeCharacterBody:InvokeServer({
                [1] = 100839513065432,
            })
            
            wait(0.5)
            local animationID = extractIdFromInput("93224413172183")
            if animationID then
                CurrentTrack = LoadTrack(animationID)
            end
        else
            local args = {
                {
                    Property = "Torso",
                    AssetId = 100839513065432
                }
            }
            game:GetService("ReplicatedStorage"):WaitForChild("BloxbizRemotes"):WaitForChild("CatalogOnApplyToRealHumanoid"):FireServer(unpack(args))
            
            wait(0.5)
            local animationID = extractIdFromInput("93224413172183")
            if animationID then
                CurrentTrack = LoadTrack(animationID)
            end
        end
    else
        ToggleButton.Text = "Fe Skybox: OFF"
        ToggleButton.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
        
        if game.PlaceId == 7822102405 then
            local args = {
                "refresh"
            }
            game:GetService("ReplicatedStorage"):WaitForChild("Events"):WaitForChild("updateCharacter"):InvokeServer(unpack(args))
            
            if CurrentTrack then
                StopTrack()
            end
        elseif game.PlaceId == 4924922222 or game:GetService("MarketplaceService"):GetProductInfo(game.PlaceId).Name:find("Brookhaven") then
            if CurrentTrack then
                StopTrack()
            end
        else
            local args = {
                {
                    Property = "Torso",
                    AssetId = 0
                }
            }
            game:GetService("ReplicatedStorage"):WaitForChild("BloxbizRemotes"):WaitForChild("CatalogOnApplyToRealHumanoid"):FireServer(unpack(args))
            game:GetService("ReplicatedStorage"):WaitForChild("BloxbizRemotes"):WaitForChild("CatalogOnResetOutfit"):FireServer()
            
            if CurrentTrack then
                StopTrack()
            end
        end
    end
end)
